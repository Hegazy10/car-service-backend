generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ServiceCategory {
  OIL
  BATTERY
  TIRE
  OTHER
}

/**
 * =========================
 * AUTH & USERS
 * =========================
 */

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  
  phone     String?
  address   String?
  city      String?
  country   String?  @default("Egypt")
  
  role      UserRole @default(USER)
  
  cars         Car[]
  orders       Order[]
  refreshToken RefreshToken? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
}

/**
 * =========================
 * CARS
 * =========================
 */

model CarBrand {
  id     String     @id @default(uuid())
  name   String     @unique
  models CarModel[]
}

model CarModel {
  id      String   @id @default(uuid())
  name    String
  brandId String
  brand   CarBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  cars    Car[]

  @@unique([name, brandId])
}

model Car {
  id        String @id @default(uuid())
  userId    String
  modelId   String
  year      Int
  mileageKm Int
  vin         String?   @unique 
  plateNumber String   @unique 
  color       String

  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  model CarModel @relation(fields: [modelId], references: [id])

  maintenanceRecords MaintenanceRecord[]
  orders             Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/**
 * =========================
 * MAINTENANCE RULES & HISTORY
 * =========================
 */

model MaintenanceRule {
  id             String   @id @default(uuid())
  
  // Relational Link instead of string name
  serviceId      String
  service        Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  intervalKm     Int?     // e.g. Every 10,000 km
  intervalMonths Int?     // e.g. Every 6 months

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt 

  @@unique([serviceId]) // Ensure one rule per service type
}

model MaintenanceRecord {
  id          String   @id @default(uuid())
  carId       String
  
  // Relational Link
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  
  mileageKm   Int      // Mileage at time of service
  notes       String?  // Mechanic notes
  performedAt DateTime @default(now())

  car         Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([carId])
  @@index([serviceId])
}

/**
 * =========================
 * INVENTORY & SERVICES
 * =========================
 */

model Part {
  id                String   @id @default(uuid())
  name              String
  sku               String   @unique // Stock Keeping Unit
  description       String?
  
  quantity          Int      @default(0)
  lowStockThreshold Int      @default(5)
  price             Decimal  @db.Decimal(10, 2)
  location          String?  // e.g. "Shelf A"

  orderItems        OrderItem[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Service {
  id              String    @id @default(uuid())
  name            String
  description     String?
  category        ServiceCategory
  basePrice       Decimal   @db.Decimal(10, 2)
  durationMinutes Int       @default(60)
  isActive        Boolean   @default(true)
  orderItems      OrderItem[]

  maintenanceRules   MaintenanceRule[]
  maintenanceRecords MaintenanceRecord[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

/**
 * =========================
 * ORDERS
 * =========================
 */

model Order {
  id         String      @id @default(uuid())
  userId     String
  carId      String
  status     OrderStatus @default(PENDING)
  totalPrice Decimal     @db.Decimal(10, 2)

  user  User        @relation(fields: [userId], references: [id])
  car   Car         @relation(fields: [carId], references: [id])
  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  
  partId    String?
  serviceId String?
  
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) // Snapshot of price at time of order

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  part      Part?    @relation(fields: [partId], references: [id])
  service   Service? @relation(fields: [serviceId], references: [id])
}
