generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InventoryType {
  PART
  SERVICE
}

enum ServiceCategory {
  OIL
  BATTERY
  TIRE
  OTHER
}

/**
 * =========================
 * AUTH & USERS
 * =========================
 */

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  
  phone     String?
  address   String?
  city      String?
  country   String?  @default("Egypt")
  
  role      UserRole @default(USER)
  
  cars         Car[]
  orders       Order[]
  refreshToken RefreshToken? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
}

/**
 * =========================
 * CARS
 * =========================
 */

model CarBrand {
  id     String     @id @default(uuid())
  name   String     @unique
  models CarModel[]
}

model CarModel {
  id      String   @id @default(uuid())
  name    String
  brandId String
  brand   CarBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  cars    Car[]

  @@unique([name, brandId])
}

model Car {
  id        String @id @default(uuid())
  userId    String
  modelId   String
  year      Int
  mileageKm Int
  vin         String?   @unique 
  plateNumber String   @unique 
  color       String

  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  model CarModel @relation(fields: [modelId], references: [id])

  maintenanceRecords MaintenanceRecord[]
  orders             Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/**
 * =========================
 * MAINTENANCE RULES & HISTORY
 * =========================
 */

model MaintenanceRule {
  id             String @id @default(uuid())
  serviceName    String
  intervalKm     Int?
  intervalMonths Int?

  createdAt DateTime @default(now())
}

model MaintenanceRecord {
  id          String   @id @default(uuid())
  carId       String
  serviceName String
  mileageKm   Int
  performedAt DateTime

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
}

/**
 * =========================
 * INVENTORY & SERVICES
 * =========================
 */

model InventoryItem {
  id           String           @id @default(uuid())
  name         String
  type         InventoryType
  category     ServiceCategory?
  price        Decimal          @db.Decimal(10, 2)
  quantity     Int
  deliveryDays Int

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id              String    @id @default(uuid())
  name            String
  description     String?
  category        ServiceCategory
  basePrice       Decimal   @db.Decimal(10, 2)
  durationMinutes Int       @default(60)
  isActive        Boolean   @default(true)
  orderItems      OrderItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

/**
 * =========================
 * ORDERS
 * =========================
 */

model Order {
  id         String      @id @default(uuid())
  userId     String
  carId      String
  status     OrderStatus @default(PENDING)
  totalPrice Decimal     @db.Decimal(10, 2)

  user  User        @relation(fields: [userId], references: [id])
  car   Car         @relation(fields: [carId], references: [id])
  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  inventoryId String?
  serviceId   String?
  quantity    Int
  price       Decimal @db.Decimal(10, 2)

  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryId], references: [id])
  service       Service?       @relation(fields: [serviceId], references: [id])
}
